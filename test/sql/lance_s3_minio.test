# name: test/sql/lance_s3_minio.test
# description: End-to-end S3 scan against MinIO using DuckDB secrets
# group: [sql]

require-env LANCE_TEST_S3 1

test-env LANCE_S3_ENDPOINT http://127.0.0.1:9000

test-env LANCE_S3_REGION us-east-1

test-env LANCE_S3_BUCKET lance-test

test-env LANCE_S3_DATASET_PREFIX test_data.lance

test-env LANCE_S3_SEARCH_DATASET_PREFIX search_test_data.lance

test-env LANCE_S3_ACCESS_KEY_ID minioadmin

test-env LANCE_S3_SECRET_ACCESS_KEY minioadmin

require lance

statement ok
INSTALL httpfs;

statement ok
LOAD httpfs;

statement ok
CREATE SECRET (
  TYPE S3,
  PROVIDER config,
  SCOPE 's3://${LANCE_S3_BUCKET}/',
  KEY_ID '${LANCE_S3_ACCESS_KEY_ID}',
  SECRET '${LANCE_S3_SECRET_ACCESS_KEY}',
  REGION '${LANCE_S3_REGION}',
  ENDPOINT '${LANCE_S3_ENDPOINT}',
  URL_STYLE 'path',
  USE_SSL false
);

query I
SELECT count(*) FROM 's3://${LANCE_S3_BUCKET}/${LANCE_S3_DATASET_PREFIX}';
----
5

query I
SELECT count(*) FROM 's3://${LANCE_S3_BUCKET}/${LANCE_S3_SEARCH_DATASET_PREFIX}';
----
5

query I
SELECT count(*) FROM lance_fts(
  's3://${LANCE_S3_BUCKET}/${LANCE_S3_SEARCH_DATASET_PREFIX}',
  'text',
  'puppy',
  k = 10
);
----
2

query I
SELECT id
FROM lance_hybrid_search(
  's3://${LANCE_S3_BUCKET}/${LANCE_S3_SEARCH_DATASET_PREFIX}',
  'vec',
  [0.0, 0.0, 0.0, 0.0]::FLOAT[],
  'text',
  'puppy',
  k = 3,
  prefilter = false,
  alpha = 0.5,
  oversample_factor = 4
)
ORDER BY _hybrid_score DESC;
----
1
3
2
