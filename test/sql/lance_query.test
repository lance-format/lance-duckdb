# name: test/sql/lance_query.test
# description: SQL surface tests for lance_*_search (vector / fts / hybrid)
# group: [sql]

require lance

# Invalid dataset root
statement error
SELECT * FROM lance_vector_search('dummy_path.lance', 'vec', [1.0]::FLOAT[], k = 1)
----
IO Error: Failed to open Lance dataset: dummy_path.lance (Lance error: dataset open 'dummy_path.lance':

# Empty query vector is rejected
statement error
SELECT * FROM lance_vector_search('test/test_data.lance', 'vec', []::FLOAT[])
----
Invalid Input Error: lance_vector_search requires a non-empty query vector

# Non-positive k is rejected
statement error
SELECT * FROM lance_vector_search('test/test_data.lance', 'vec', [1.0]::FLOAT[], k = 0)
----
Invalid Input Error: lance_vector_search requires k > 0

# Sanity: dataset is readable
query I
SELECT count(*) FROM 'test/search_test_data.lance'
----
5

# Basic FTS search with explicit column
query I
SELECT count(*) FROM lance_fts('test/search_test_data.lance', 'text', 'puppy', k = 10)
----
2

# FTS + prefilter: ensure filters are applied before top-k
query I
SELECT id
FROM lance_fts('test/search_test_data.lance', 'text', 'puppy', k = 10, prefilter = true)
WHERE label >= 3
ORDER BY id
----
3

# Vector search: deterministic top-k ordering by distance
query I
SELECT id
FROM lance_vector_search(
  'test/search_test_data.lance',
  'vec',
  [0.0, 0.0, 0.0, 0.0]::FLOAT[],
  k = 3,
  use_index = false
)
ORDER BY _distance
----
1
2
3

# Vector search + prefilter: top-k is computed after filters
query I
SELECT id
FROM lance_vector_search(
  'test/search_test_data.lance',
  'vec',
  [0.0, 0.0, 0.0, 0.0]::FLOAT[],
  k = 10,
  prefilter = true,
  use_index = false
)
WHERE label >= 4
ORDER BY _distance
----
4
5

# Hybrid search (vector + fts)
query I
SELECT id
FROM lance_hybrid_search(
  'test/search_test_data.lance',
  'vec',
  [0.0, 0.0, 0.0, 0.0]::FLOAT[],
  'text',
  'puppy',
  k = 3,
  prefilter = false,
  alpha = 0.5,
  oversample_factor = 4
)
ORDER BY _hybrid_score DESC
----
1
3
2

# Hybrid search with oversample_factor default alpha
query I
SELECT id
FROM lance_hybrid_search(
  'test/search_test_data.lance',
  'vec',
  [0.0, 0.0, 0.0, 0.0]::FLOAT[],
  'text',
  'puppy',
  k = 3,
  prefilter = false,
  oversample_factor = 4
)
ORDER BY _hybrid_score DESC
----
1
3
2
