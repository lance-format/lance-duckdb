# name: test/sql/lance_search.test
# description: SQL surface tests for lance_search (vector / fts / hybrid)
# group: [sql]

require lance

# Invalid dataset root
statement error
SELECT * FROM lance_search('dummy_path.lance', [1.0]::FLOAT[], 1)
----
IO Error: Failed to open Lance dataset: dummy_path.lance (Lance error: dataset open 'dummy_path.lance':

# Empty query vector is rejected
statement error
SELECT * FROM lance_search('test/test_data.lance', []::FLOAT[], 1)
----
Invalid Input Error: lance_search requires a non-empty query vector

# Non-positive k is rejected
statement error
SELECT * FROM lance_search('test/test_data.lance', [1.0]::FLOAT[], 0)
----
Invalid Input Error: lance_search requires k > 0

# Sanity: dataset is readable
query I
SELECT count(*) FROM 'test/search_test_data.lance'
----
5

# Basic FTS search with explicit column
query I
SELECT count(*) FROM lance_search('test/search_test_data.lance', 'puppy', text_column = 'text', k = 10)
----
2

# MatchQuery-style structured search (same semantics as plain text query)
query I
SELECT count(*) FROM lance_search('test/search_test_data.lance', lance_match_query('puppy', 'text'), k = 10)
----
2

# FTS + prefilter: ensure filters are applied before top-k
query I
SELECT id
FROM lance_search('test/search_test_data.lance', 'puppy', text_column = 'text', k = 10, prefilter = true)
WHERE label >= 3
ORDER BY id
----
3

# Vector search: deterministic top-k ordering by distance
query I
SELECT id
FROM lance_search(
  'test/search_test_data.lance',
  [0.0, 0.0, 0.0, 0.0]::FLOAT[],
  k = 3,
  vector_column = 'vec',
  use_index = false
)
ORDER BY _distance
----
1
2
3

# Vector search + prefilter: top-k is computed after filters
query I
SELECT id
FROM lance_search(
  'test/search_test_data.lance',
  [0.0, 0.0, 0.0, 0.0]::FLOAT[],
  k = 10,
  vector_column = 'vec',
  prefilter = true,
  use_index = false
)
WHERE label >= 4
ORDER BY _distance
----
4
5

# Hybrid search (vector + fts)
query I
SELECT id
FROM lance_search(
  'test/search_test_data.lance',
  lance_hybrid_query(
    [0.0, 0.0, 0.0, 0.0]::FLOAT[],
    'puppy',
    'vec',
    'text',
    0.5,
    4
  ),
  k = 3,
  prefilter = false
)
ORDER BY _hybrid_score DESC
----
1
3
2
