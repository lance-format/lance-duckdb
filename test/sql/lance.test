# name: test/sql/lance.test
# description: Test the lance extension
# group: [sql]

require lance

# Basic extension loading test
query I
SELECT 1
----
1

# Test that lance_scan can read a local dataset root
statement ok
SELECT * FROM lance_scan('test/test_data.lance') LIMIT 1

# Test parallel scan + filter pushdown
statement ok
PRAGMA threads=4

query I
SELECT count(*) FROM 'test/test_data.lance' WHERE age > 30
----
3

query I
SELECT count(*) FROM 'test/test_data.lance' WHERE name IN ('Alice', 'Eve')
----
2

query I
SELECT count(*) FROM 'test/test_data.lance' WHERE age > 30 AND score < 90
----
2

# Test complex filter forms (OR across columns, NOT, BETWEEN, NOT IN)
query I
SELECT count(*) FROM 'test/test_data.lance' WHERE age > 30 OR score < 90
----
4

query I
SELECT count(*) FROM 'test/test_data.lance' WHERE NOT (age > 30)
----
2

query I
SELECT count(*) FROM 'test/test_data.lance' WHERE age BETWEEN 26 AND 40
----
3

query I
SELECT count(*) FROM 'test/test_data.lance' WHERE name NOT IN ('Alice', 'Eve')
----
3

# Projection + filter correctness (also exercises projection pushdown path)
query T
SELECT name FROM 'test/test_data.lance' WHERE age > 30 ORDER BY name
----
Charlie
David
Eve

# Test replacement scan for SELECT * FROM '.../dataset.lance'
statement ok
SELECT * FROM 'test/test_data.lance' LIMIT 1

# Test error handling - invalid dataset root
statement error
SELECT * FROM lance_scan('dummy_path.lance')
----
IO Error: Failed to open Lance dataset: dummy_path.lance (Lance error: dataset open 'dummy_path.lance':

# Test error handling - requires at least one argument
statement error
SELECT * FROM lance_scan()
----
